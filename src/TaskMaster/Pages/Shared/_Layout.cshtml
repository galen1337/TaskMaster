<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>@ViewData["Title"] - TaskMaster</title>
	<script type="importmap"></script>
	<link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
	<link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
	<link rel="stylesheet" href="~/TaskMaster.styles.css" asp-append-version="true" />
	<style>
		body { min-height: 100vh; }
		.sidebar { position: fixed; top: 0; bottom: 0; left: 0; width: 250px; padding: 1rem; background: #0d6efd; color:#fff; }
		.sidebar .nav-link, .sidebar .brand { color:#fff !important; }
		.sidebar .dropdown-toggle::after{ display:none; }
		.sidebar .caret { margin-left: 6px; transition: transform .2s ease; }
		.sidebar .caret.open { transform: rotate(90deg); }
		.sidebar .submenu { display:none; padding-left:.75rem; }
		.sidebar .submenu.show { display:block; }
		.content { margin-left: 260px; }
		.brand { font-weight: 600; font-size: 1.25rem; display: block; margin-bottom: .75rem; }
	</style>
</head>
<body>
	<div class="sidebar">
		@if (User.Identity?.IsAuthenticated ?? false)
		{
			<a class="brand" asp-controller="Projects" asp-action="Index">TaskMaster</a>
		}
		else
		{
			<a class="brand" asp-area="" asp-page="/Index">TaskMaster</a>
		}
		<ul class="nav flex-column mb-3">
			<li class="nav-item">
				@if (User.Identity?.IsAuthenticated ?? false)
				{
					<a class="nav-link d-flex align-items-center" asp-controller="Projects" asp-action="Index" id="projectsLink">
						<span>Projects</span>
						<span class="caret">›</span>
					</a>
					<div class="submenu" id="projectsSubmenu">
						<div class="small text-white-50 mb-1">Quick access</div>
						<ul class="nav flex-column" id="projectsQuickList"></ul>
					</div>
				}
				else
				{
					<a class="nav-link" asp-area="Identity" asp-page="/Account/Login" asp-route-returnUrl="/Projects">Projects</a>
				}
			</li>
			@if (User.Identity?.IsAuthenticated ?? false)
			{
				<li class="nav-item">
					<a class="nav-link" asp-controller="Invites" asp-action="Inbox">Inbox</a>
				</li>
			}
			<li class="nav-item">
				<a class="nav-link" asp-area="" asp-page="/Privacy">Privacy</a>
			</li>
		</ul>
		<div>
			<partial name="_LoginPartial" />
		</div>
	</div>
	<div class="content">
		<main role="main" class="container py-3">
			@RenderBody()
		</main>
		<footer class="border-top footer text-muted">
			<div class="container">
				&copy; 2025 - TaskMaster - <a asp-area="" asp-page="/Privacy">Privacy</a>
			</div>
		</footer>
	</div>

	<script src="~/lib/jquery/dist/jquery.min.js"></script>
	<script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src="~/js/site.js" asp-append-version="true"></script>

	<script>
		(function(){
			const success = '@(TempData["Success"] as string)';
			const error = '@(TempData["Error"] as string)';
			if (success) {
				Swal.fire({ toast: true, position: 'top-end', timer: 1500, timerProgressBar: true, icon: 'success', title: success, showConfirmButton: false });
			}
			if (error) {
				Swal.fire({ toast: true, position: 'top-end', timer: 3500, timerProgressBar: true, icon: 'error', title: error, showConfirmButton: false });
			}

			// Sidebar projects submenu
			const link = document.getElementById('projectsLink');
			const submenu = document.getElementById('projectsSubmenu');
			const caret = link ? link.querySelector('.caret') : null;
			if (link) {
				link.addEventListener('click', (e) => {
					// Default behavior navigates to Projects index. But if caret clicked, toggle submenu only
					if (e.target && e.target.classList.contains('caret')) {
						e.preventDefault();
						submenu?.classList.toggle('show');
						caret?.classList.toggle('open');
					}
				});
				// Populate quick list
				fetch('/Projects/UserList', { headers: { 'X-Requested-With':'XMLHttpRequest' } })
					.then(r => r.ok ? r.json() : [])
					.then(items => {
						const ul = document.getElementById('projectsQuickList');
						if (!ul || !Array.isArray(items)) return;
						ul.innerHTML = '';
						items.forEach(p => {
							const li = document.createElement('li');
							li.className = 'nav-item';
							li.innerHTML = `<a class="nav-link" href="/Projects/Details/${p.id}">${p.name}</a>`;
							ul.appendChild(li);
						});
					});
			}
		})();
	</script>

	@await RenderSectionAsync("Scripts", required: false)
</body>
</html>
